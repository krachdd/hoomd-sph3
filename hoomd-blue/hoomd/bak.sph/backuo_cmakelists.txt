# Maintainer: David Krach

##################################
# Set sources
set(_sph_sources module.cc)

# MODIFY THIS IF NEW CPP SOURCES ARE ADDED
set(_sph_cpu_sources SPHIntegratorTwoStep.cc
                     SPHIntegrationMethodTwoStep.cc
                     VelocityVerlet.cc
                     SuspendedObjectIntegrator.cc
                     RigidBodyIntegrator.cc
                     StateEquationsExport.cc
                     SPHBaseClass.cc
                     SinglePhaseFlow.cc
                     TwoPhaseFlow.cc
                     SmoothingKernelExport.cc
                     )

if (NOT ENABLE_HIP)
list(APPEND _sph_cpu_sources StateEquations.cc
                             SmoothingKernel.cc)
endif()
if (ENABLE_HIP)
list(APPEND _sph_cpu_sources VelocityVerletGPU.cc
                             #SuspendedObjectIntegratorGPU.cc
                             RigidBodyIntegratorGPU.cc
                             SinglePhaseFlowGPU.cc
                             TwoPhaseFlowGPU.cc
                             )
endif()

set(_sph_cu_sources VelocityVerletGPU.cu
                    #SuspendedObjectIntegratorGPU.cu
                    RigidBodyIntegratorGPU.cu
                    SPHBaseClass.cu
                    SinglePhaseFlowGPU.cu
                    SmoothingKernel.cu
                    StateEquations.cu
                    TwoPhaseFlowGPU.cu
                    GeneralGPUFunctions.cu
                    GeneralGPUDeviceFunctions.cu
                    )


foreach(src ${_sph_cpu_sources})
  list(APPEND _sph_sources ${src})
endforeach()

# Need to define NO_IMPORT_ARRAY in every file but module.cc
set_source_files_properties(${_sph_sources} ${_sph_cu_sources} PROPERTIES COMPILE_DEFINITIONS NO_IMPORT_ARRAY)

if (ENABLE_HIP)
CUDA_ADD_LIBRARY(_gpusph ${_sph_cu_sources} OPTIONS -Xcompiler -fPIC SHARED)
endif (ENABLE_HIP)

add_library (_sph SHARED ${_sph_sources})

# link the library to its dependencies
if  (ENABLE_HIP)
target_link_libraries(_sph _hoomd ${HOOMD_COMMON_LIBS} _gpusph)
else (ENABLE_HIP)
target_link_libraries(_sph _hoomd ${HOOMD_COMMON_LIBS} )
endif (ENABLE_HIP)

# if we are compiling with MPI support built in, set appropriate
# compiler/linker flags
if (ENABLE_MPI)
   if(MPI_COMPILE_FLAGS)
       set_target_properties(_sph PROPERTIES COMPILE_FLAGS "${MPI_CXX_COMPILE_FLAGS}")
   endif(MPI_COMPILE_FLAGS)
   if(MPI_LINK_FLAGS)
       set_target_properties(_sph PROPERTIES LINK_FLAGS "${MPI_CXX_LINK_FLAGS}")
   endif(MPI_LINK_FLAGS)
endif(ENABLE_MPI)

##################################
# change the name of the library to be a valid python module
# tweak the properties of the output to make a functional python module
set_target_properties(_sph PROPERTIES PREFIX "" OUTPUT_NAME "_sph")

# .dylib is not recognized as a python module by python on Mac OS X
if(APPLE)
    set_target_properties(_sph PROPERTIES SUFFIX ".so")
endif(APPLE)
fix_cudart_rpath(_sph)

# install the library
install(TARGETS _sph
        LIBRARY DESTINATION ${PYTHON_MODULE_BASE_DIR}/sph
        )

################ Python only modules
# copy python modules to the build directory to make it a working python package
MACRO(copy_file file)
    add_custom_command (
        OUTPUT ${file}
        DEPENDS ${file}
        POST_BUILD
        COMMAND    ${CMAKE_COMMAND}
        ARGS       -E copy ${CMAKE_CURRENT_SOURCE_DIR}/${file} ${CMAKE_CURRENT_BINARY_DIR}/${file}
        COMMENT    "Copy hoomd/sph/${file}"
    )
ENDMACRO(copy_file)

#  MODIFY THIS IF NEW PYTHON MODULES ARE ADDED
set(files   __init__.py
            integrate.py
            force.py
            kernel.py
            eos.py
            models.py
    )

install(FILES ${files}
        DESTINATION ${PYTHON_MODULE_BASE_DIR}/sph
       )

foreach(file ${files})
    copy_file(${file})
endforeach()

add_custom_target(copy_sph ALL DEPENDS ${files})
